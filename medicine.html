<!doctype html><html lang="ko"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>약품관리 A안</title><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><style>*{box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;margin:0;background:#f6f7fb;padding:12px}.wrap{max-width:900px;margin:0 auto}h2{margin:8px 0 10px}.top{display:grid;grid-template-columns:1fr auto auto;gap:6px}#q{grid-column:1/-1}input,button{padding:9px;border:1px solid #dcdfe6;border-radius:10px}.pill{padding:6px 10px;border:1px solid #dcdfe6;border-radius:999px;background:#fff}.muted{color:#6b7280}.card{background:#fff;border:1px solid #eaedf5;border-radius:10px;padding:10px;margin:8px 0}.row{display:grid;grid-template-columns:44px 1fr 102px 58px;gap:6px;align-items:center}.name{font-weight:600}.code{font-size:12px;color:#6b7280}.btn-sm{padding:6px 8px;font-size:12px}.sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top-left-radius:14px;border-top-right-radius:14px;border:1px solid #e5e7eb;padding:12px;box-shadow:0 -8px 20px rgba(0,0,0,.08);display:none;z-index:30}.sheet .g{display:grid;grid-template-columns:1fr 1fr;gap:8px}.sheet input{width:100%}.sheet .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:20}</style></head><body><div class="wrap"><h2>약품관리 시스템 (A안: 하단 편집패널)</h2><div class="top"><input id="q" placeholder="약품명/번호/코드 검색"/><button id="adminLogin">관리자 로그인</button><button id="adminLogout" style="display:none">로그아웃</button><button id="adminAdd" style="display:none">행 추가</button><button id="adminClear" style="display:none">전체 삭제</button><span id="mode" class="pill">조회 전용</span><button id="reload">새로고침</button></div><div id="status" class="muted" style="margin:8px 0">연결 중...</div><div id="list"></div></div><div id="ov" class="overlay"></div><div id="sheet" class="sheet"><div class="g"><div><div class="muted">번호</div><input id="fNo" inputmode="numeric"/></div><div><div class="muted">유효기간(YYMMDD 가능)</div><input id="fExp" placeholder="YYYY-MM-DD"/></div><div><div class="muted">약품명</div><input id="fName"/></div><div><div class="muted">약품코드</div><input id="fCode"/></div></div><div class="actions"><button id="sDel">삭제</button><button id="sCancel">취소</button><button id="sSave">저장</button></div></div><script>const URL='https://lkcugkmkabeeeigkazzn.supabase.co',KEY='sb_publishable_27Iqc8Qukobl8cK0PGUwzQ_HM5Gzw3n',PWD='qwer1234',SK='med-admin-session-v1';const db=supabase.createClient(URL,KEY);let rows=[],isAdmin=sessionStorage.getItem(SK)==='1',editing=null;const $=id=>document.getElementById(id);const n=v=>String(v??'').normalize('NFC').trim();function nd(v){const r=n(v);if(!r)return'';const d=r.replace(/[^0-9]/g,'');if(d.length===6)return`20${d.slice(0,2)}-${d.slice(2,4)}-${d.slice(4,6)}`;if(d.length===8)return`${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}`;const m=r.match(/^(\d{4})[-./](\d{1,2})[-./](\d{1,2})$/);if(m)return`${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;return null;}function mode(){ $('mode').textContent=isAdmin?'관리자 편집 가능':'조회 전용'; $('adminLogin').style.display=isAdmin?'none':'inline-block'; $('adminLogout').style.display=isAdmin?'inline-block':'none'; $('adminAdd').style.display=isAdmin?'inline-block':'none'; $('adminClear').style.display=isAdmin?'inline-block':'none'; }function render(){const k=n($('q').value).toLowerCase();const view=rows.filter(r=>!k||String(r.no).includes(k)||n(r.name).toLowerCase().includes(k)||n(r.code).toLowerCase().includes(k));$('list').innerHTML=view.map(r=>`<div class='card'><div class='row'><div>${r.no}</div><div><div class='name'>${r.name}</div><div class='code'>${r.code}</div></div><div style='text-align:right'>${r.expiry_date||'—'}</div><div>${isAdmin?`<button class='btn-sm' data-edit='${r.id}'>편집</button>`:'-'}</div></div></div>`).join('');document.querySelectorAll('[data-edit]').forEach(b=>b.onclick=()=>openSheet(Number(b.dataset.edit)));}async function load(){ $('status').textContent='불러오는 중...';const {data,error}=await db.from('medicine_inventory').select('*').order('no',{ascending:true}); if(error){$('status').textContent='불러오기 실패: '+error.message;return;} rows=(data||[]).map(r=>({id:r.id,no:Number(r.no),name:n(r.name),code:n(r.code),expiry_date:r.expiry_date?n(r.expiry_date):''}));$('status').textContent=`총 ${rows.length}건`;render();}function openSheet(id){editing=rows.find(x=>x.id===id);if(!editing)return;$('fNo').value=editing.no;$('fName').value=editing.name;$('fCode').value=editing.code;$('fExp').value=editing.expiry_date||'';$('ov').style.display='block';$('sheet').style.display='block';}function closeSheet(){$('ov').style.display='none';$('sheet').style.display='none';editing=null;}async function saveSheet(){if(!editing)return;const no=Number(n($('fNo').value)),name=n($('fName').value),code=n($('fCode').value),exp=nd($('fExp').value);if(!Number.isFinite(no)||no<=0)return alert('번호 확인');if(!name||!code)return alert('약품명/코드 확인');if(exp===null)return alert('날짜 형식 확인');const p={no,name,code,expiry_date:exp||null};const {error}=await db.from('medicine_inventory').update(p).eq('id',editing.id);if(error)return alert(error.message);Object.assign(editing,p,{expiry_date:exp});closeSheet();render();}async function delSheet(){if(!editing||!confirm('삭제할까요?'))return;const {error}=await db.from('medicine_inventory').delete().eq('id',editing.id);if(error)return alert(error.message);rows=rows.filter(x=>x.id!==editing.id);closeSheet();render();}async function addRow(){const max=rows.reduce((m,r)=>Math.max(m,r.no||0),0);const no=Number(prompt('번호',String(max+1))||'');if(!no)return;const name=n(prompt('약품명','신규 약품')||'');const code=n(prompt('약품코드','new_code')||'');if(!name||!code)return;const {data,error}=await db.from('medicine_inventory').insert({no,name,code,expiry_date:null}).select('*').single();if(error)return alert(error.message);rows.push({id:data.id,no:Number(data.no),name:n(data.name),code:n(data.code),expiry_date:data.expiry_date||''});rows.sort((a,b)=>a.no-b.no);render();}async function clearAll(){if(!confirm('전체 삭제?'))return;const {error}=await db.from('medicine_inventory').delete().gt('id',0);if(error)return alert(error.message);rows=[];render();}$('q').oninput=render;$('reload').onclick=load;$('adminLogin').onclick=()=>{const p=prompt('관리자 비밀번호');if(p&&n(p)===PWD){isAdmin=true;sessionStorage.setItem(SK,'1');mode();render();}};$('adminLogout').onclick=()=>{isAdmin=false;sessionStorage.removeItem(SK);mode();render();};$('adminAdd').onclick=addRow;$('adminClear').onclick=clearAll;$('ov').onclick=closeSheet;$('sCancel').onclick=closeSheet;$('sSave').onclick=saveSheet;$('sDel').onclick=delSheet;mode();load();</script></body></html>