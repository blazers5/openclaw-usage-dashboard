<!doctype html><html lang="ko"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>약품관리 B안</title><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><style>*{box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;margin:0;background:#f6f7fb;padding:12px}.wrap{max-width:1100px;margin:0 auto}h2{margin:8px 0 10px}.top{display:grid;grid-template-columns:1fr auto auto;gap:6px}#q{grid-column:1/-1}input,button{padding:9px;border:1px solid #dcdfe6;border-radius:10px}.pill{padding:6px 10px;border:1px solid #dcdfe6;border-radius:999px;background:#fff}.muted{color:#6b7280}.tbl{margin-top:10px;border:1px solid #e8ecf4;border-radius:10px;overflow:hidden}table{width:100%;border-collapse:collapse;background:#fff}th,td{font-size:13px;padding:8px;border-bottom:1px solid #edf1f7}tbody tr:nth-child(odd){background:#fbfcff}.cell{width:100%;padding:6px;font-size:12px}.act{display:flex;gap:4px}.act button{padding:5px 7px;font-size:11px}.ok{color:#0f766e}.err{color:#b91c1c}@media(max-width:900px){th:nth-child(1),td:nth-child(1){width:36px}th:nth-child(2),td:nth-child(2){width:auto}th:nth-child(3),td:nth-child(3){width:112px;text-align:right}th:nth-child(4),td:nth-child(4){width:92px}th:nth-child(5),td:nth-child(5){display:none} .top{grid-template-columns:1fr auto}}</style></head><body><div class="wrap"><h2>약품관리 시스템 (B안: 인라인 편집)</h2><div class="top"><input id="q" placeholder="약품명/번호/코드 검색"/><button id="adminLogin">관리자 로그인</button><button id="adminLogout" style="display:none">로그아웃</button><button id="adminAdd" style="display:none">행추가</button><button id="adminClear" style="display:none">전체삭제</button><span id="mode" class="pill">조회 전용</span><button id="reload">새로고침</button></div><div id="status" class="muted" style="margin-top:8px">연결 중...</div><div class='tbl'><table><thead><tr><th>번호</th><th>약품명(코드)</th><th>유효기간</th><th>저장</th><th>D</th></tr></thead><tbody id='tb'></tbody></table></div></div><script>const URL='https://lkcugkmkabeeeigkazzn.supabase.co',KEY='sb_publishable_27Iqc8Qukobl8cK0PGUwzQ_HM5Gzw3n',PWD='qwer1234',SK='med-admin-session-v1';const db=supabase.createClient(URL,KEY);let rows=[],isAdmin=sessionStorage.getItem(SK)==='1';const $=id=>document.getElementById(id);const n=v=>String(v??'').normalize('NFC').trim();function nd(v){const r=n(v);if(!r)return'';const d=r.replace(/[^0-9]/g,'');if(d.length===6)return`20${d.slice(0,2)}-${d.slice(2,4)}-${d.slice(4,6)}`;if(d.length===8)return`${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}`;const m=r.match(/^(\d{4})[-./](\d{1,2})[-./](\d{1,2})$/);if(m)return`${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;return null;}function dd(d){if(!d)return'—';const t=new Date(d);if(isNaN(t))return'—';const n0=new Date();n0.setHours(0,0,0,0);return 'D-'+Math.floor((t-n0)/86400000);}function esc(s){return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}function mode(){ $('mode').textContent=isAdmin?'관리자 편집 가능':'조회 전용'; $('adminLogin').style.display=isAdmin?'none':'inline-block'; $('adminLogout').style.display=isAdmin?'inline-block':'none'; $('adminAdd').style.display=isAdmin?'inline-block':'none'; $('adminClear').style.display=isAdmin?'inline-block':'none'; }function rowV(r){if(!isAdmin)return`<tr data-id='${r.id}'><td>${r.no}</td><td>${esc(r.name)} <span class='muted'>(${esc(r.code)})</span></td><td>${r.expiry_date||'—'}</td><td>-</td><td>${dd(r.expiry_date)}</td></tr>`;return`<tr data-id='${r.id}'><td><input class='cell' data-f='no' value='${esc(r.no)}'/></td><td><input class='cell' data-f='name' value='${esc(r.name)}'/><input class='cell' data-f='code' value='${esc(r.code)}' style='margin-top:4px'/></td><td><input class='cell' data-f='expiry_date' placeholder='YYYY-MM-DD / YYMMDD' value='${esc(r.expiry_date||'')}'/></td><td><div class='act'><button data-a='save'>저장</button><button data-a='del'>삭제</button></div></td><td>${dd(r.expiry_date)}</td></tr>`;}function render(){const k=n($('q').value).toLowerCase();const view=rows.filter(r=>!k||String(r.no).includes(k)||n(r.name).toLowerCase().includes(k)||n(r.code).toLowerCase().includes(k));$('tb').innerHTML=view.map(rowV).join('');document.querySelectorAll('[data-a="save"]').forEach(b=>b.onclick=saveR);document.querySelectorAll('[data-a="del"]').forEach(b=>b.onclick=delR);}async function load(){const {data,error}=await db.from('medicine_inventory').select('*').order('no',{ascending:true});if(error){$('status').textContent='실패: '+error.message;$('status').className='err';return;}rows=(data||[]).map(r=>({id:r.id,no:Number(r.no),name:n(r.name),code:n(r.code),expiry_date:r.expiry_date?n(r.expiry_date):''}));$('status').textContent='총 '+rows.length+'건';$('status').className='muted ok';render();}async function saveR(e){const tr=e.target.closest('tr'),id=Number(tr.dataset.id);const no=Number(n(tr.querySelector('[data-f="no"]').value));const name=n(tr.querySelector('[data-f="name"]').value);const code=n(tr.querySelector('[data-f="code"]').value);const exp=nd(tr.querySelector('[data-f="expiry_date"]').value);if(!no||!name||!code)return alert('입력 확인');if(exp===null)return alert('날짜형식 확인');const {error}=await db.from('medicine_inventory').update({no,name,code,expiry_date:exp||null}).eq('id',id);if(error)return alert(error.message);const i=rows.findIndex(x=>x.id===id);rows[i]={...rows[i],no,name,code,expiry_date:exp};render();}async function delR(e){if(!confirm('삭제?'))return;const id=Number(e.target.closest('tr').dataset.id);const {error}=await db.from('medicine_inventory').delete().eq('id',id);if(error)return alert(error.message);rows=rows.filter(x=>x.id!==id);render();}async function addR(){const max=rows.reduce((m,r)=>Math.max(m,r.no||0),0);const no=Number(prompt('번호',String(max+1))||'');if(!no)return;const name=n(prompt('약품명','신규 약품')||'');const code=n(prompt('약품코드','new_code')||'');const {data,error}=await db.from('medicine_inventory').insert({no,name,code,expiry_date:null}).select('*').single();if(error)return alert(error.message);rows.push({id:data.id,no:Number(data.no),name:n(data.name),code:n(data.code),expiry_date:data.expiry_date||''});rows.sort((a,b)=>a.no-b.no);render();}async function clearR(){if(!confirm('전체삭제?'))return;const {error}=await db.from('medicine_inventory').delete().gt('id',0);if(error)return alert(error.message);rows=[];render();}$('q').oninput=render;$('reload').onclick=load;$('adminLogin').onclick=()=>{const p=prompt('관리자 비밀번호');if(p&&n(p)===PWD){isAdmin=true;sessionStorage.setItem(SK,'1');mode();render();}};$('adminLogout').onclick=()=>{isAdmin=false;sessionStorage.removeItem(SK);mode();render();};$('adminAdd').onclick=addR;$('adminClear').onclick=clearR;mode();load();</script></body></html>