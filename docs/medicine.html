<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>?쏀뭹愿由??쒖뒪??(Supabase)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;margin:0;background:#f6f7fb;padding:14px}
    .wrap{max-width:1200px;margin:0 auto}
    .sticky-tools{position:sticky;top:0;z-index:15;background:#f6f7fb;padding-top:6px;padding-bottom:6px}
    .top{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,button{padding:10px;border:1px solid #ddd;border-radius:10px}
    input{font-size:15px}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #eee;border-radius:12px;overflow:hidden}
    th,td{padding:9px 10px;border-bottom:1px solid #eef1f6;text-align:left;font-size:14px;vertical-align:middle;line-height:1.35}
    .muted{color:#6b7280;font-size:12px}
    .pill{padding:3px 8px;border:1px solid #ddd;border-radius:999px;background:#fff}
    .row{margin-top:10px}
    .table-wrap{overflow:auto;-webkit-overflow-scrolling:touch}
    .footer{margin-top:10px;color:#666;font-size:12px}
    .cell-input{width:100%;min-width:96px;padding:8px;font-size:13px}
    .save-btn{padding:6px 10px;font-size:12px}
    .save-wrap{display:flex;gap:6px;align-items:center}
    .med-link{all:unset;color:#0b57d0;cursor:pointer;text-decoration:underline;text-underline-offset:2px}
    tbody tr:nth-child(odd){background:#fbfcff}
    tbody tr:nth-child(even){background:#ffffff}
    .ok{color:#0f766e}.err{color:#b91c1c}

    @media (max-width: 768px){
      h2{font-size:30px;margin-bottom:10px}
      .top{display:grid;grid-template-columns:1fr auto;gap:8px}
      #q{grid-column:1 / -1}
      table{min-width:700px}
      th,td{font-size:13px;padding:8px}
      .save-btn{padding:9px 10px}
    }

    @media (max-width: 900px){
      .top{display:grid;grid-template-columns:1fr auto auto;gap:6px}
      #q{grid-column:1 / -1}
      .table-wrap{overflow-x:hidden}
      table{width:100%;min-width:0;border:1px solid #e7ebf3;background:#fff;table-layout:fixed}
      thead{display:table-header-group}
      tbody{display:table-row-group}
      tr{display:table-row}
      td{display:table-cell;padding:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
      th{font-size:12px;padding:8px 8px;background:#f4f7ff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
      /* 紐⑤컮?? 踰덊샇/?쏀뭹紐?媛꾧꺽 異뺤냼 + ?좏슚湲곌컙 ?좊챸?섍쾶 */
      th:nth-child(1), td:nth-child(1){width:40px;padding-right:2px}
      th:nth-child(2), td:nth-child(2){width:auto; white-space:normal; word-break:keep-all; overflow:visible; text-overflow:clip; line-height:1.35; padding-left:2px}
      th:nth-child(3), td:nth-child(3){width:126px; text-align:right; white-space:nowrap}
      th:nth-child(4), td:nth-child(4){width:48px}
      td[data-label]::before{content:none}
      .cell-input{min-width:0;padding:6px 6px;font-size:12px}
      td:nth-child(1) .cell-input{width:100%;padding:6px 4px;text-align:center}
      td:nth-child(3) .cell-input{width:100%;padding:6px 2px;font-size:10.5px;text-align:center}
      .save-wrap{display:flex;flex-direction:column;justify-content:flex-start;gap:3px;align-items:stretch}
      .save-btn{width:100%;min-width:0;padding:4px 3px;font-size:10px;line-height:1.1}
      .footer{font-size:11px}
    }

    .float-wrap{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(92vw,760px);max-height:80vh;z-index:30;background:#fff;border:1px solid #dbe2f0;border-radius:12px;box-shadow:0 12px 34px rgba(0,0,0,.2);display:none}
    .float-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eef2f8;background:#f7f9ff}
    .float-body{padding:10px 12px;overflow:auto;max-height:calc(80vh - 48px)}
    .drug-list{list-style:none;padding:0;margin:8px 0;display:flex;flex-direction:column;gap:8px}
    .drug-list li{border:1px solid #e9edf5;border-radius:10px;padding:9px;background:#fcfdff}
    .drug-list a{color:#0b57d0;text-decoration:none}
    .drug-list a:hover{text-decoration:underline}
    .drug-snippet{display:block;color:#4b5563;font-size:12px;margin-top:4px;line-height:1.4}
    .drug-actions{display:flex;justify-content:flex-end;margin-top:8px}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:20}
    .modal{width:min(92vw,360px);background:#fff;border-radius:12px;padding:16px;border:1px solid #eee}
    .modal h3{margin:0 0 10px;font-size:16px}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  </style>
</head>
<body>
<div class="wrap">
  <h2>?쏀뭹愿由??쒖뒪??(怨듭쑀??</h2>
  <div class="sticky-tools">
    <div class="top">
      <input id="q" placeholder="?쏀뭹紐?踰덊샇/肄붾뱶 寃?? style="flex:1;min-width:240px" />
      <button id="adminLogin">愿由ъ옄 濡쒓렇??/button>
      <button id="adminLogout" style="display:none">濡쒓렇?꾩썐</button>
      <button id="adminAddRow" style="display:none">??異붽?</button>
      <span id="mode" class="pill">議고쉶 ?꾩슜</span>
      <button id="reload">?덈줈怨좎묠</button>
    </div>

    <div class="row muted" id="status">?곌껐 以?..</div>
  </div>

  <div class="row table-wrap">
    <table>
      <thead>
        <tr>
          <th style="width:64px">踰덊샇</th>
          <th>?쏀뭹紐?肄붾뱶)</th>
          <th style="width:120px">?좏슚湲곌컙</th>
          <th style="width:72px">???/th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>

  <div class="footer">湲곕낯 議고쉶 ?꾩슜 / 愿由ъ옄 濡쒓렇????踰덊샇쨌?쏀뭹紐끒룹빟?덉퐫?쑣룹쑀?④린媛?紐⑤몢 ?몄쭛 ?????⑥쐞 ???媛??/div>
</div>

<div id="drugFloat" class="float-wrap" role="dialog" aria-modal="true" aria-label="?쏀뭹 寃??寃곌낵">
  <div class="float-head">
    <b id="drugFloatTitle">?쏀뭹 ?뺣낫</b>
    <button id="drugFloatClose">?リ린</button>
  </div>
  <div class="float-body">
    <div id="drugFloatLoading" class="muted">寃??以?..</div>
    <div id="drugFloatError" class="muted err" style="display:none"></div>
    <ul id="drugFloatList" class="drug-list"></ul>
    <div class="drug-actions">
      <a id="drugFloatOpenNaver" target="_blank" rel="noopener noreferrer">?ㅼ씠踰??먮Ц ?닿린</a>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="pwModal">
  <div class="modal">
    <h3>愿由ъ옄 濡쒓렇??/h3>
    <input id="pwInput" type="password" placeholder="鍮꾨?踰덊샇 ?낅젰" style="width:100%" />
    <div class="actions">
      <button id="pwCancel">痍⑥냼</button>
      <button id="pwConfirm">濡쒓렇??/button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://lkcugkmkabeeeigkazzn.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_27Iqc8Qukobl8cK0PGUwzQ_HM5Gzw3n';
const ADMIN_PASSWORD = 'qwer1234';
const ADMIN_SESSION_KEY = 'med-admin-session-v1';

let isAdmin = sessionStorage.getItem(ADMIN_SESSION_KEY) === '1';
let rows = [];
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const tb = document.getElementById('tb');
const q = document.getElementById('q');
const statusEl = document.getElementById('status');
const modeEl = document.getElementById('mode');
const loginBtn = document.getElementById('adminLogin');
const logoutBtn = document.getElementById('adminLogout');
const adminAddRowBtn = document.getElementById('adminAddRow');
const pwModal = document.getElementById('pwModal');
const pwInput = document.getElementById('pwInput');
const NAVER_PROXY_ENDPOINTS = [
  '/api/naver-search',
  'https://dedda587d0cff3.lhr.life/api/naver-search'
];
const NAVER_READABLE_SEARCH = 'https://r.jina.ai/http://search.naver.com/search.naver?where=nexearch&query=';
const drugFloat = document.getElementById('drugFloat');
const drugFloatTitle = document.getElementById('drugFloatTitle');
const drugFloatClose = document.getElementById('drugFloatClose');
const drugFloatLoading = document.getElementById('drugFloatLoading');
const drugFloatError = document.getElementById('drugFloatError');
const drugFloatList = document.getElementById('drugFloatList');
const drugFloatOpenNaver = document.getElementById('drugFloatOpenNaver');

function nfc(v){ return String(v ?? '').normalize('NFC').trim(); }
function esc(s){ return String(s ?? '').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function normalizeDateInput(v){
  const s = nfc(v).replace(/\D/g,'');
  if(s.length !== 6) return s;
  const yy = s.slice(0,2);
  const mm = s.slice(2,4);
  const dd = s.slice(4,6);
  return `20${yy}-${mm}-${dd}`;
}
function dday(d){ if(!d) return '??; const t = new Date(d); if(isNaN(t)) return '??; const now = new Date(); now.setHours(0,0,0,0); const diff = Math.floor((t-now)/(1000*60*60*24)); return diff>=0 ? `D-${diff}` : '留뚮즺'; }

function setMode(){
  modeEl.textContent = isAdmin ? '愿由ъ옄 ?몄쭛 媛?? : '議고쉶 ?꾩슜';
  loginBtn.style.display = isAdmin ? 'none' : 'inline-block';
  logoutBtn.style.display = isAdmin ? 'inline-block' : 'none';
  adminAddRowBtn.style.display = isAdmin ? 'inline-block' : 'none';
}

function rowView(r){
  if(!isAdmin){
    return `
      <tr data-id="${r.id}">
        <td data-label="踰덊샇">${r.no}</td>
        <td data-label="?쏀뭹紐?><button type="button" class="med-link" data-name="${esc(r.name)}">${esc(r.name)}</button> <span class="muted">(${esc(r.code)})</span></td>
        <td data-label="?좏슚湲곌컙">${r.expiry_date || '??}</td>
        <td data-label="??? class="muted">-</td>
      </tr>`;
  }

  return `
    <tr data-id="${r.id}">
      <td data-label="踰덊샇"><input class="cell-input" inputmode="numeric" data-field="no" value="${esc(r.no)}" /></td>
      <td data-label="?쏀뭹紐?>
        <input class="cell-input" data-field="name" value="${esc(r.name)}" style="margin-top:4px" />
        <input class="cell-input" data-field="code" value="${esc(r.code)}" style="margin-top:4px" />
      </td>
      <td data-label="?좏슚湲곌컙"><input class="cell-input" type="text" inputmode="numeric" placeholder="yymmdd" data-field="expiry_date" value="${esc((r.expiry_date || '').replace(/-/g,''))}" /></td>
      <td data-label="???>
        <div class="save-wrap">
          <button class="save-btn" data-action="save">???/button>
          <button class="save-btn" data-action="delete">??젣</button>
        </div>
      </td>
    </tr>`;
}

function stripHtml(text){ return String(text ?? '').replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim(); }

function isJunkNaverResult(title, link, qText){
  const t = String(title || '').trim().toLowerCase();
  const l = String(link || '').toLowerCase();

  if(!t || !l) return true;
  if(t === '_naver_' || t === '@naver.com') return true;
  if(t.includes('n pay') || t.includes('pay') || t.includes('메일') || t.includes('블로그') || t.includes('카페') || t.includes('알림') || t.includes('톡')) return true;
  if(/\/mail|\/blog|\/cafe|\/pay|\/talk|\/mypage|\/my\//i.test(l)) return true;
  if(/help\.naver\.com|policy\.naver\.com|nid\.naver\.com/i.test(l)) return true;

  if(qText){
    const q = String(qText).toLowerCase();
    if(!(`${t} ${l}`).includes(q)) return true;
  }
  return false;
}

function parseJinaFallback(text, qText){
  const raw = String(text || '');
  const out = [];
  const seen = new Set();

  const re = /\[([^\]]+)\]\((https?:\/\/[^)\s]+)\)/g;
  let m;
  while((m = re.exec(raw)) !== null){
    const title = stripHtml(m[1] || '').trim();
    const link = m[2] || '';
    if(!title || !link) continue;
    if(isJunkNaverResult(title, link, qText)) continue;
    if(seen.has(link)) continue;
    seen.add(link);
    out.push({ title, link, snippet: '네이버 검색 결과' });
    if(out.length >= 8) break;
  }

  return out;
}

function sanitizeResults(items, qText, qEncoded){
  const badRe = /SecurityCompromiseError|blocked until|Too many domains|DDos|Anonymous access|\{\s*"?data"?\s*:/i;
  const safe = (Array.isArray(items) ? items : []).filter(item => {
    const title = stripHtml(item?.title || '');
    const snippet = stripHtml(item?.snippet || item?.description || '');
    const link = String(item?.link || '');
    if(!/^https?:\/\//i.test(link)) return false;
    if(isJunkNaverResult(title, link, qText)) return false;
    if(badRe.test(title) || badRe.test(snippet)) return false;
    if(title.trim().startsWith('{') || snippet.trim().startsWith('{')) return false;
    return true;
  });
  return safe.length ? safe : buildGuaranteedResults(qEncoded);
}
function renderDrugResults(items){
  if(!Array.isArray(items) || items.length === 0){
    drugFloatList.innerHTML = '<li class="muted">寃??寃곌낵媛 ?놁뒿?덈떎.</li>';
    return;
  }
  drugFloatList.innerHTML = items.map(item => {
    const title = esc(stripHtml(item.title || '?쒕ぉ ?놁쓬'));
    const link = esc(item.link || '#');
    const snippet = esc(stripHtml(item.snippet || item.description || ''));
    return `<li><a href="${link}" target="_blank" rel="noopener noreferrer">${title}</a>${snippet ? `<span class="drug-snippet">${snippet}</span>` : ''}</li>`;
  }).join('');
}

async function fetchProxyResults(q){
  let lastError = null;
  for(const endpoint of NAVER_PROXY_ENDPOINTS){
    try {
      const res = await fetch(`${endpoint}?q=${q}`);
      if(!res.ok) { lastError = new Error(`HTTP ${res.status}`); continue; }
      const json = await res.json();
      if(Array.isArray(json.results)) return json.results;
    } catch (e) {
      lastError = e;
    }
  }
  throw lastError || new Error('proxy_unavailable');
}

function buildGuaranteedResults(qEncoded){
  return [
    {
      title: '?ㅼ씠踰??듯빀寃??,
      link: `https://search.naver.com/search.naver?where=nexearch&query=${qEncoded}`,
      snippet: '?쏀뭹紐낆쓣 湲곗??쇰줈 ?ㅼ씠踰??듯빀寃??寃곌낵瑜??쎈땲??'
    },
    {
      title: '?ㅼ씠踰??댁뒪',
      link: `https://search.naver.com/search.naver?where=news&query=${qEncoded}`,
      snippet: '愿???댁뒪/湲곗궗 以묒떖 寃곌낵瑜??뺤씤?⑸땲??'
    },
    {
      title: '?ㅼ씠踰?吏?쓎N',
      link: `https://search.naver.com/search.naver?where=kin&query=${qEncoded}`,
      snippet: '?ъ슜??吏덈Ц/?듬? 以묒떖 寃곌낵瑜??뺤씤?⑸땲??'
    }
  ];
}

async function fetchFallbackResults(qEncoded, qText){
  try {
    const res = await fetch(`${NAVER_READABLE_SEARCH}${qEncoded}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    const parsed = parseJinaFallback(text, qText);
    if(parsed.length) return parsed;
  } catch {}
  return buildGuaranteedResults(qEncoded);
}

async function openDrugInfo(name){
  const qText = nfc(name);
  const qEncoded = encodeURIComponent(qText);
  const naverUrl = `https://search.naver.com/search.naver?where=nexearch&query=${qEncoded}`;
  drugFloatTitle.textContent = `?쏀뭹 ?뺣낫: ${qText}`;
  drugFloatOpenNaver.href = naverUrl;
  drugFloat.style.display = 'block';
  drugFloatLoading.style.display = 'block';
  drugFloatError.style.display = 'none';
  drugFloatList.innerHTML = '';

  try {
    const results = sanitizeResults(await fetchProxyResults(qEncoded), qText, qEncoded);
    if(results.length > 0){
      renderDrugResults(results);
      return;
    }
    const fallback = sanitizeResults(await fetchFallbackResults(qEncoded, qText), qText, qEncoded);
    renderDrugResults(fallback);
    if(fallback.length){
      drugFloatError.textContent = '?꾨줉??誘몄뿰寃??곹깭濡??泥?寃??寃곌낵瑜??쒖떆?덉뒿?덈떎.';
      drugFloatError.style.display = 'block';
    }
  } catch (err) {
    try {
      const fallback = sanitizeResults(await fetchFallbackResults(qEncoded, qText), qText, qEncoded);
      renderDrugResults(fallback);
      if(fallback.length){
        drugFloatError.textContent = '?꾨줉??誘몄뿰寃??곹깭濡??泥?寃??寃곌낵瑜??쒖떆?덉뒿?덈떎.';
        drugFloatError.style.display = 'block';
      } else {
        throw new Error('fallback-empty');
      }
    } catch {
      const guaranteed = buildGuaranteedResults(qEncoded);
      renderDrugResults(guaranteed);
      drugFloatError.textContent = '?ㅼ떆媛?寃곌낵 ?섏쭛??吏?곕릺???泥?寃??移대뱶瑜??쒖떆?덉뒿?덈떎.';
      drugFloatError.style.display = 'block';
    }
  } finally {
    drugFloatLoading.style.display = 'none';
  }
}

function closeDrugInfo(){
  drugFloat.style.display = 'none';
  drugFloatLoading.style.display = 'none';
  drugFloatError.style.display = 'none';
  drugFloatList.innerHTML = '';
  drugFloatOpenNaver.removeAttribute('href');
}

function render(){
  const k = nfc(q.value).toLowerCase();
  const filtered = rows.filter(r => !k || String(r.no).includes(k) || nfc(r.name).toLowerCase().includes(k) || nfc(r.code).toLowerCase().includes(k));
  tb.innerHTML = filtered.map(rowView).join('');
  tb.querySelectorAll('.med-link').forEach(btn => btn.addEventListener('click', () => openDrugInfo(btn.dataset.name || '')));
  tb.querySelectorAll('button[data-action="save"]').forEach(btn => btn.addEventListener('click', saveRow));
  tb.querySelectorAll('button[data-action="delete"]').forEach(btn => btn.addEventListener('click', deleteRow));
}

async function loadData(){
  statusEl.textContent = '?곗씠??遺덈윭?ㅻ뒗 以?..';
  const { data, error } = await db.from('medicine_inventory').select('*').order('no', {ascending:true});
  if(error){ statusEl.textContent = '遺덈윭?ㅺ린 ?ㅽ뙣: ' + error.message; statusEl.className='row muted err'; return; }
  rows = (data||[]).map(r => ({
    id: r.id,
    no: Number(r.no),
    name: nfc(r.name),
    code: nfc(r.code),
    expiry_date: r.expiry_date ? nfc(r.expiry_date) : ''
  }));
  statusEl.textContent = `珥?${rows.length}嫄?濡쒕뱶 ?꾨즺`;
  statusEl.className='row muted ok';
  render();
}

async function deleteRow(e){
  const btn = e.target;
  const prevText = btn.textContent;
  if(!confirm('???됱쓣 ??젣?좉퉴??')) return;

  btn.disabled = true;
  btn.textContent = '??젣以?;

  try {
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    const { error } = await db.from('medicine_inventory').delete().eq('id', id);
    if(error){
      alert('??젣 ?ㅽ뙣: ' + error.message + '\n\n(??젣 ?뺤콉???놁쓣 ???덉뼱. ?쒓? 諛붾줈 SQL ??以??쒕━寃좎뒿?덈떎.)');
      return;
    }
    rows = rows.filter(x => String(x.id) !== String(id));
    statusEl.textContent = `??젣 ?꾨즺 (ID ${id})`;
    statusEl.className='row muted ok';
    render();
  } finally {
    btn.disabled = false;
    btn.textContent = prevText;
  }
}

async function addRow(){
  const maxNo = rows.reduce((m,r)=>Math.max(m, Number(r.no)||0), 0);
  const noInput = prompt('??踰덊샇 ?낅젰', String(maxNo + 1));
  if(noInput === null) return;
  const no = Number(nfc(noInput));
  if(!Number.isFinite(no) || no <= 0){ alert('踰덊샇??1 ?댁긽???レ옄?ъ빞 ?⑸땲??'); return; }
  const name = nfc(prompt('?쏀뭹紐??낅젰', '?좉퇋 ?쏀뭹') || '');
  if(!name){ alert('?쏀뭹紐낆쓣 ?낅젰?댁빞 ?⑸땲??'); return; }
  const code = nfc(prompt('?쏀뭹肄붾뱶 ?낅젰', 'new_code') || '');
  if(!code){ alert('?쏀뭹肄붾뱶瑜??낅젰?댁빞 ?⑸땲??'); return; }

  const payload = { no, name, code, expiry_date: null };
  const { data, error } = await db.from('medicine_inventory').insert(payload).select('*').single();
  if(error){ alert('??異붽? ?ㅽ뙣: ' + error.message); return; }

  rows.push({
    id: data.id,
    no: Number(data.no),
    name: nfc(data.name),
    code: nfc(data.code),
    expiry_date: data.expiry_date ? nfc(data.expiry_date) : ''
  });
  rows.sort((a,b)=>a.no-b.no);
  statusEl.textContent = `??異붽? ?꾨즺 (ID ${data.id})`;
  statusEl.className='row muted ok';
  render();
}

async function saveRow(e){
  const btn = e.target;
  const prevText = btn.textContent;
  btn.disabled = true;
  btn.textContent = '??μ쨷';

  try {
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    const no = Number(nfc(tr.querySelector('[data-field="no"]').value));
    const name = nfc(tr.querySelector('[data-field="name"]').value);
    const code = nfc(tr.querySelector('[data-field="code"]').value);
    const expiry = normalizeDateInput(tr.querySelector('[data-field="expiry_date"]').value);

    if(!Number.isFinite(no) || no <= 0){ alert('踰덊샇??1 ?댁긽???レ옄濡??낅젰?댁＜?몄슂.'); return; }
    if(!name){ alert('?쏀뭹紐낆? 鍮꾩썙?????놁뒿?덈떎.'); return; }
    if(!code){ alert('?쏀뭹肄붾뱶??鍮꾩썙?????놁뒿?덈떎.'); return; }
    if(expiry && !/^\d{4}-\d{2}-\d{2}$/.test(expiry)){ alert('?좏슚湲곌컙? yymmdd ?뺤떇?쇰줈 ?낅젰?댁＜?몄슂. (?? 280131)'); return; }

    const payload = { no, name, code, expiry_date: expiry || null };
    const { error } = await db.from('medicine_inventory').update(payload).eq('id', id);
    if(error){ alert('????ㅽ뙣: ' + error.message); return; }

    const idx = rows.findIndex(x => String(x.id) === String(id));
    if(idx >= 0){ rows[idx] = { ...rows[idx], ...payload, expiry_date: expiry }; }

    statusEl.textContent = `????꾨즺 (ID ${id})`;
    statusEl.className='row muted ok';
    render();
  } finally {
    btn.disabled = false;
    btn.textContent = prevText;
  }
}

function openPwModal(){ pwModal.style.display='flex'; pwInput.value=''; setTimeout(()=>pwInput.focus(), 10); }
function closePwModal(){ pwModal.style.display='none'; }

q.addEventListener('input', render);
loginBtn.addEventListener('click', openPwModal);
logoutBtn.addEventListener('click', ()=>{ isAdmin=false; sessionStorage.removeItem(ADMIN_SESSION_KEY); setMode(); render(); });
document.getElementById('reload').addEventListener('click', loadData);
adminAddRowBtn.addEventListener('click', addRow);

document.getElementById('pwCancel').addEventListener('click', closePwModal);
document.getElementById('pwConfirm').addEventListener('click', ()=>{
  if(nfc(pwInput.value) === ADMIN_PASSWORD){
    isAdmin = true;
    sessionStorage.setItem(ADMIN_SESSION_KEY, '1');
    setMode();
    closePwModal();
    render();
  } else {
    alert('鍮꾨?踰덊샇媛 ?щ컮瑜댁? ?딆뒿?덈떎.');
  }
});
pwInput.addEventListener('keydown', (ev)=>{ if(ev.key === 'Enter') document.getElementById('pwConfirm').click(); });
pwModal.addEventListener('click', (ev)=>{ if(ev.target === pwModal) closePwModal(); });
drugFloatClose.addEventListener('click', closeDrugInfo);

setMode();
loadData();
</script>
</body>
</html>
