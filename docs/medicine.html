<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>약품관리 시스템 (Supabase)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;margin:0;background:#f6f7fb;padding:14px}
    .wrap{max-width:1200px;margin:0 auto}
    .top{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,button{padding:10px;border:1px solid #ddd;border-radius:10px}
    input{font-size:15px}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #eee;border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid #f1f1f1;text-align:left;font-size:14px;vertical-align:middle}
    .muted{color:#6b7280;font-size:12px}
    .pill{padding:3px 8px;border:1px solid #ddd;border-radius:999px;background:#fff}
    .row{margin-top:10px}
    .footer{margin-top:10px;color:#666;font-size:12px}
    .cell-input{width:100%;min-width:110px}
    .save-btn{padding:7px 10px;font-size:12px}
    .save-wrap{display:flex;gap:6px;align-items:center}
    .ok{color:#0f766e}.err{color:#b91c1c}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:20}
    .modal{width:min(92vw,360px);background:#fff;border-radius:12px;padding:16px;border:1px solid #eee}
    .modal h3{margin:0 0 10px;font-size:16px}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  </style>
</head>
<body>
<div class="wrap">
  <h2>약품관리 시스템 (공유형)</h2>
  <div class="top">
    <input id="q" placeholder="약품명/번호/코드 검색" style="flex:1;min-width:240px" />
    <button id="adminLogin">관리자 로그인</button>
    <button id="adminLogout" style="display:none">로그아웃</button>
    <span id="mode" class="pill">조회 전용</span>
    <button id="reload">새로고침</button>
  </div>

  <div class="row muted" id="status">연결 중...</div>

  <div class="row">
    <table>
      <thead>
        <tr>
          <th style="width:90px">번호</th>
          <th>약품명</th>
          <th style="width:170px">약품코드</th>
          <th style="width:160px">유효기간</th>
          <th style="width:90px">D-Day</th>
          <th style="width:90px">저장</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>

  <div class="footer">기본 조회 전용 / 관리자 로그인 시 번호·약품명·약품코드·유효기간 모두 편집 후 행 단위 저장 가능</div>
</div>

<div class="modal-backdrop" id="pwModal">
  <div class="modal">
    <h3>관리자 로그인</h3>
    <input id="pwInput" type="password" placeholder="비밀번호 입력" style="width:100%" />
    <div class="actions">
      <button id="pwCancel">취소</button>
      <button id="pwConfirm">로그인</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://lkcugkmkabeeeigkazzn.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_27Iqc8Qukobl8cK0PGUwzQ_HM5Gzw3n';
const ADMIN_PASSWORD = 'qwer1234';
const ADMIN_SESSION_KEY = 'med-admin-session-v1';

let isAdmin = sessionStorage.getItem(ADMIN_SESSION_KEY) === '1';
let rows = [];
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const tb = document.getElementById('tb');
const q = document.getElementById('q');
const statusEl = document.getElementById('status');
const modeEl = document.getElementById('mode');
const loginBtn = document.getElementById('adminLogin');
const logoutBtn = document.getElementById('adminLogout');
const pwModal = document.getElementById('pwModal');
const pwInput = document.getElementById('pwInput');

function nfc(v){ return String(v ?? '').normalize('NFC').trim(); }
function esc(s){ return String(s ?? '').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function dday(d){ if(!d) return '—'; const t = new Date(d); if(isNaN(t)) return '—'; const now = new Date(); now.setHours(0,0,0,0); const diff = Math.floor((t-now)/(1000*60*60*24)); return diff>=0 ? `D-${diff}` : '만료'; }

function setMode(){
  modeEl.textContent = isAdmin ? '관리자 편집 가능' : '조회 전용';
  loginBtn.style.display = isAdmin ? 'none' : 'inline-block';
  logoutBtn.style.display = isAdmin ? 'inline-block' : 'none';
}

function rowView(r){
  if(!isAdmin){
    return `
      <tr data-id="${r.id}">
        <td>${r.no}</td>
        <td>${esc(r.name)}</td>
        <td><code>${esc(r.code)}</code></td>
        <td>${r.expiry_date || '—'}</td>
        <td>${dday(r.expiry_date)}</td>
        <td class="muted">-</td>
      </tr>`;
  }

  return `
    <tr data-id="${r.id}">
      <td><input class="cell-input" data-field="no" value="${esc(r.no)}" /></td>
      <td><input class="cell-input" data-field="name" value="${esc(r.name)}" /></td>
      <td><input class="cell-input" data-field="code" value="${esc(r.code)}" /></td>
      <td><input class="cell-input" type="date" data-field="expiry_date" value="${esc(r.expiry_date || '')}" /></td>
      <td>${dday(r.expiry_date)}</td>
      <td>
        <div class="save-wrap">
          <button class="save-btn" data-action="save">저장</button>
        </div>
      </td>
    </tr>`;
}

function render(){
  const k = nfc(q.value).toLowerCase();
  const filtered = rows.filter(r => !k || String(r.no).includes(k) || nfc(r.name).toLowerCase().includes(k) || nfc(r.code).toLowerCase().includes(k));
  tb.innerHTML = filtered.map(rowView).join('');
  tb.querySelectorAll('button[data-action="save"]').forEach(btn => btn.addEventListener('click', saveRow));
}

async function loadData(){
  statusEl.textContent = '데이터 불러오는 중...';
  const { data, error } = await db.from('medicine_inventory').select('*').order('no', {ascending:true});
  if(error){ statusEl.textContent = '불러오기 실패: ' + error.message; statusEl.className='row muted err'; return; }
  rows = (data||[]).map(r => ({
    id: r.id,
    no: Number(r.no),
    name: nfc(r.name),
    code: nfc(r.code),
    expiry_date: r.expiry_date ? nfc(r.expiry_date) : ''
  }));
  statusEl.textContent = `총 ${rows.length}건 로드 완료`;
  statusEl.className='row muted ok';
  render();
}

async function saveRow(e){
  const tr = e.target.closest('tr');
  const id = tr.dataset.id;
  const no = Number(nfc(tr.querySelector('[data-field="no"]').value));
  const name = nfc(tr.querySelector('[data-field="name"]').value);
  const code = nfc(tr.querySelector('[data-field="code"]').value);
  const expiry = nfc(tr.querySelector('[data-field="expiry_date"]').value);

  if(!Number.isFinite(no) || no <= 0){ alert('번호는 1 이상의 숫자로 입력해주세요.'); return; }
  if(!name){ alert('약품명은 비워둘 수 없습니다.'); return; }
  if(!code){ alert('약품코드는 비워둘 수 없습니다.'); return; }

  const payload = { no, name, code, expiry_date: expiry || null };
  const { error } = await db.from('medicine_inventory').update(payload).eq('id', id);
  if(error){ alert('저장 실패: ' + error.message); return; }

  const idx = rows.findIndex(x => String(x.id) === String(id));
  if(idx >= 0){ rows[idx] = { ...rows[idx], ...payload, expiry_date: expiry }; }

  statusEl.textContent = `저장 완료 (ID ${id})`;
  statusEl.className='row muted ok';
  render();
}

function openPwModal(){ pwModal.style.display='flex'; pwInput.value=''; setTimeout(()=>pwInput.focus(), 10); }
function closePwModal(){ pwModal.style.display='none'; }

q.addEventListener('input', render);
loginBtn.addEventListener('click', openPwModal);
logoutBtn.addEventListener('click', ()=>{ isAdmin=false; sessionStorage.removeItem(ADMIN_SESSION_KEY); setMode(); render(); });
document.getElementById('reload').addEventListener('click', loadData);

document.getElementById('pwCancel').addEventListener('click', closePwModal);
document.getElementById('pwConfirm').addEventListener('click', ()=>{
  if(nfc(pwInput.value) === ADMIN_PASSWORD){
    isAdmin = true;
    sessionStorage.setItem(ADMIN_SESSION_KEY, '1');
    setMode();
    closePwModal();
    render();
  } else {
    alert('비밀번호가 올바르지 않습니다.');
  }
});
pwInput.addEventListener('keydown', (ev)=>{ if(ev.key === 'Enter') document.getElementById('pwConfirm').click(); });
pwModal.addEventListener('click', (ev)=>{ if(ev.target === pwModal) closePwModal(); });

setMode();
loadData();
</script>
</body>
</html>